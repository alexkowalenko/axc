# AXC - Writing a C Compiler

Implementing a C compiler, following the book Nora Sandler, _Writing a C Compiler_ (No Starch Press, 2024).

Written in verbose C++ 23, using STL particular std::variant, std::visit, and the Visitor pattern. 
The various ASDL (Abstract Syntax Definition Language) definitions are implemented as classes, generated by a Python script.

## Thoughts on Design:
- Using `std::variant` and `std::visit` allows implementing abstract sum types in C++ (and not using unsafe `union`s).
However `std::variant` is very verbose with `std::visit`, requiring a lambda for each type in the variant. 
Also if you get it wrong, the compiler will not tell you  which type is missing, just that it is missing - 
usually using hundreds of lines of template error messages.

- I am not sure strictly using the Visitor pattern is the best way to implement a compiler. The Parser and TAC (Three Address Code) 
generation are very similar, and don't use the Visitor pattern. The Parser uses a recursive descent parser, and is free
to define what methods it needs, without having to implement a Visitor interface. 

- Various times in the book, the author suggests using a new pass to handle a semantic analysis step. I have tried not
to do this, as it would lead to a lot of boilerplate code to set up a new pass. Writing a new pass in other languages
would be easier in other languages. There are two passes for generating the X86_64 assembler code, but since the code
generated for X86_64 needs to be fixed, due to non-orthogonal instructions, it makes sense to have a separate pass.

- The generation of the ASDL classes saves a lot of boilerplate code, and allows for easy extension of the compiler. It saves
hand coding the many classes, which would be tedious and error prone. I picked up this from Nystrom's _Crafting Interpreters_ book.
In the age of AI, you could also use a LLM to generate the classes.

- To pass the test suite, you need to place the checks in the order determined by the book. You might to do some checks
at the parser lever, but you won't pass the tests then, since the tests according to the book are done in the semantic
analysis pass. This is annoying. 

## Status

Finished up to Chapter 10, code generated for X86_64; Chapter 4 for code generated for AArch64. 
Tested on MacOS and FreeBSD.

## Chapter 1 Minimal Compiler
- [X] Infrastructure.
- [X] Lexer.
- [X] AST, Parser.
- [X] Assembler Tree (AT), Code Generator.
- [X] File output X86_64 assembler code.
- [x] File output AArch64 assembler code.

## Chapter 2 Unary Operators
- [X] Lexer.
- [X] AST, Parser.
- [X] TAC intermediate.
- [X] Code Generator X86_64:
  - [X] Assembler Tree, Code generator
  - [X] Replacing pseudo registers.
  - [X] Fix instructions
- [X] Output: X86_64
- [X] Code Generator AArch64:
  - [X] Assembler Tree, Code generator
  - [X] Replacing pseudo registers.
- [x] Output: AArch64

## Chapter 3 Binary Operators
- [X] Lexer.
- [X] Parser.
- [X] TAC intermediate.
- [X] Code Generator.
- [X] Output X86_64.
- [x] Output AArch64.
- [X] Extra: Bitwise Operators &,|,Ë†,<<,>>
- [x] Extra: AArch64.

## Chapter 4 Logical and Relational Operators
- [X] Lexer.
- [X] Parser.
- [X] TAC intermediate.
- [X] Code Generator.
- [X] Output: X86_64
- [x] Output: AArch64

## Chapter 5 Local Variables
- [x] Lexer.
- [x] Parser.
- [x] Semantic Analysis.
- [x] TAC intermediate.
- [x] Extra:
  - [x] Increment/Decrement operators
  - [x] Compound assignment.

## Chapter 6 If Statements and Conditional Expressions
- [x] Lexer.
- [x] Parser.
- [x] Semantic Analysis.
- [x] TAC intermediate.
- [x] Extra: Labels and goto

## Chapter 7 Compound Statements
- [x] Parser.
- [x] Semantic Analysis.
- [x] TAC intermediate.

## Chapter 8 Loops
- [x] Lexer.
- [x] Parser.
- [x] Semantic Analysis.
- [x] TAC Intermediate.
- [x] Extra: switch statements
  - [x] Lexer, Parser.
  - [x] Semantic Analysis.
  - [x] TAC Intermediate.

## Chapter 9 Functions
- [x] Lexer.
- [x] Parser.
- [x] Semantic Analysis.
- [x] TAC Intermediate.
- [x] Code Generator.
- [x] Output: X86_64.
- [ ] Output: AArch64.

## Chapter 10 File Scope Variables and Storage Classes
- [x] Lexer.
- [x] Parser.
- [ ] Semantic Analysis.
- [ ] TAC Intermediate.
- [ ] Code Generator.
- [x] Output: X86_64.
- [ ] Output: AArch64.

## Chapter 11 Long Integers
- [x] Lexer.
- [ ] Parser.
- [ ] Semantic Analysis.
- [ ] TAC Intermediate.
- [ ] Code Generator.
- [ ] Output: X86_64.
- [ ] Output: AArch64.

## Chapter 19 Optimizing TAC Instructions